<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>EuconetAPIClient</title>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
        <link rel="stylesheet" href="style.css">
    </head>
    
    
    <body>
        <div id="cpudiv">

            <div id="cpuHeading_svg"><img src="img/cpu_icon.svg" /></div>
            <div id="cpuHeading_text">CPU</div>
            <div id="cpu_params">
                <div id="cpu_model"> </div>
                <div id="avg_cpu_usage"></div>
                <div id="max_cpu_speed"></div>
                <div id="cpu_speed"></div>
            </div>
            <canvas id="cpuchart" width="1000px" height="200px"></canvas>
            
            <script>
                var labels = [];
                var values = [];
                
                
                
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", "JSONStorage.json", false);
                rawFile.onreadystatechange = function () {
                    if(rawFile.readyState === 4) {
                        if(rawFile.status === 200 || rawFile.status == 0) {
                            recievedJSON = JSON.parse(rawFile.responseText);
                            var keys = Object.keys(recievedJSON);
                            for (let i = 0; i < keys.length; i++) {
                                var currentJSON = JSON.parse(recievedJSON[i]);
                                if(i === 0) {
                                    var cpu_model = currentJSON["cpu_model"].replace("(R)", "&reg;").replace("(TM)", "&trade;")
                                    document.getElementById("cpu_model").innerHTML = "CPU Model: " + cpu_model;
                                    var cpu_speed = currentJSON["cpu_speed"]
                                    document.getElementById("cpu_speed").innerHTML = "CPU Speed: " + cpu_speed + "MHz";
                                }
                                values.push(currentJSON["cpu_usage"]);
                                labels.push(currentJSON["time"]);
                            }
                            
                            var roundedValues = values.map(function(each_element){
                                return Number(each_element.toFixed(0));
                            });

                            var maxRoundedCpuUsage = Math.max.apply(null, roundedValues)
                            var indexOfMaxCPUusage = roundedValues.indexOf(maxRoundedCpuUsage)
                            var PositionInrealValues = values[indexOfMaxCPUusage]

                            var sumOfValues = values.reduce((partialSum, a) => partialSum + a, 0, sumOfValues = parseFloat(sumOfValues).toFixed(2))
                            var avg_cpu_usage = sumOfValues / values.length;

                            var avg_cpu_usage = parseFloat(avg_cpu_usage).toFixed(2) + "%";
                            document.getElementById("avg_cpu_usage").innerHTML = "Average CPU usage: " + avg_cpu_usage
                            document.getElementById("max_cpu_speed").innerHTML = "Maximum CPU usage: " + PositionInrealValues + "%"
                            
                        }
                    }
                }
                
                rawFile.send(null);
                
                
                
                
                
                var ctx = document.getElementById("cpuchart").getContext("2d");
                var cpuchartelement = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "CPU usage",
                            data: values,
                            fill: false,
                            borderColor: "#bae755",
                            borderWidth : 0.7,
                            backgroundColor: "#bae755",
                            tension: 0,
                            pointRadius: 1,
                            pointHitRadius: 300
                        }],
                    },
                    
                    options: {
                        plugins: {
                            zoom: {
                                pan: {
                                    enabled: true,
                                    mode: "xy"
                                },
                                limits: {
                                    y: {min: 0, max: 100},
                                },
                                zoom: {
                                    wheel: {
                                        enabled: true
                                    }
                                }
                            }
                        },
                        animation: true,
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                min: 0,
                                max: 100
                            }
                        }
                    }
                })
                
                function resetcpuChartZoom() {
                    cpuchartelement.resetZoom();
                }
                </script>
            <button id="cpuInfoZoomBtn"  onclick="resetcpuChartZoom()">Reset Zoom</button>
        </div>
    </body>
    </html>